# OfficeHoursQ - Cursor Rules
# Real-time office hours queue management app with three user roles.
# This file is the highest-priority context for every prompt. Keep it current.


## Project Overview

OfficeHoursQ is a real-time queue management tool for university office hours.
Three roles: Student (submits questions), TA (manages the queue), Professor (analytics and session management).
Students submit structured questions during active sessions. TAs claim, resolve, or defer them. Professors view analytics and control sessions.


## Tech Stack

- Frontend: React 18+ with Vite (JavaScript), Tailwind CSS, Lucide React icons, Recharts for charts
- Backend: Node.js with Express
- Database: MongoDB with Mongoose ODM
- Real-time: Socket.io (JWT-authenticated on handshake, rooms scoped to sessions)
- Auth: JWT (jsonwebtoken) + bcrypt for password hashing
- Validation: express-validator on backend, manual validation on frontend
- No state management libraries (no Redux, no Zustand). Use React Context for auth and socket state. Use useState/useEffect for everything else.


## Monorepo Structure

```
/
├── client/                     # React frontend (Vite)
│   ├── src/
│   │   ├── components/         # Grouped by feature, NOT by type
│   │   │   ├── auth/           # LoginForm, RegisterForm
│   │   │   ├── common/         # NavBar, Badge, StatCard, Button, Input, Select, Pill
│   │   │   ├── student/        # SubmitQuestionForm, QueueStatus, SimilarQuestions
│   │   │   ├── ta/             # TAQueue, QuestionCard, QuestionDetail
│   │   │   ├── professor/      # AnalyticsDashboard, CategoryChart, TrendsChart, TAPerformance
│   │   │   ├── course/         # CourseList, JoinCourse, CreateCourse
│   │   │   ├── session/        # SessionList, CreateSession, SessionControls
│   │   │   └── notifications/  # NotificationBell, NotificationList
│   │   ├── pages/              # Top-level route pages
│   │   ├── hooks/              # Custom hooks (useSocket, useAuth, useQueue, etc.)
│   │   ├── context/            # AuthContext, SocketContext
│   │   ├── services/           # API call functions (axios or fetch wrappers)
│   │   └── utils/              # Helpers, constants, formatters
│   ├── tailwind.config.js
│   └── package.json
├── server/
│   ├── models/                 # Mongoose schemas (PascalCase singular: User.js, Question.js)
│   ├── routes/                 # Express routers (camelCase: authRoutes.js, questionRoutes.js)
│   ├── controllers/            # Route handlers (camelCase: authController.js)
│   ├── middleware/              # auth.js (JWT verify), roleCheck.js, validate.js
│   ├── utils/                  # Helpers (queueCalculator.js, etc.)
│   ├── config/                 # db.js, socket.js, env config
│   ├── server.js               # Entry point
│   └── package.json
└── .cursorrules
```


## Source of Truth Documents

These documents live in the project root. When in doubt, consult them in this priority order:

1. `OfficeHoursQ_PRD.md` - Behavioral source of truth. Data models, API specs, validation rules, edge cases, queue logic, notification triggers. PRD wins over mockup on any behavioral question.
2. `OfficeHoursQ-Mockup.jsx` - Visual source of truth. Colors, layout, component styles, interaction flows, design tokens. Mockup wins over wireframes on any layout question.
3. `OfficeHoursQ_Implementation_Plan.md` - Build order source of truth. Governs what to build next and in what sequence. Follow phases exactly.
4. Hand-drawn wireframes (3 JPEG images in project root) - Secondary visual reference. Only consult if the mockup doesn't cover a layout question.


## Data Models (Quick Reference)

Eight models. See PRD for full field definitions.

- User: id, email, name, role (student|ta|professor), created_at
- Course: id, name, invite_code (6-char, unique, auto-generated), professor_id, created_at
- CourseEnrollment: id, course_id, user_id, role (student|ta), joined_at. Unique on (course_id, user_id).
- Session: id, course_id, title, date, start_time, end_time, status (scheduled|active|ended), topics[], is_recurring, recurring_pattern, created_by, created_at. Max one active session per course.
- SessionTaAssignment: id, session_id, ta_id
- Question: id, session_id, course_id, student_id, title, description, code_snippet, error_message, what_tried, category (debugging|conceptual|setup|assignment|other), priority (low|medium|high), status (queued|in_progress|resolved|deferred|withdrawn|unresolved), claimed_by_ta_id, resolution_note, helpful_votes, submitted_at, claimed_at, resolved_at, deferred_at. One active question (queued or in_progress) per student per session.
- HelpfulVote: id, question_id, student_id. Unique on (question_id, student_id).
- Notification: id, user_id, type, message, related_question_id, related_session_id, is_read, created_at


## Queue Logic

- Sort order: priority (high=0, medium=1, low=2), then submitted_at ASC within same priority.
- Exception: deferred questions always go to the absolute back, sorted by deferred_at.
- Estimated wait: position * avg_resolve_time. Default to 5 min/position if no resolved questions yet. Cap display at "60+ min".
- Recalculate on: every claim, resolve, defer, withdraw, or new submission.
- After recalculating, broadcast updated positions via Socket.io to the session room.


## Role-Based Access (Default: Deny)

Before implementing ANY endpoint or UI component, determine which roles can access it.

- Student: submit questions, edit own queued questions, withdraw own questions, vote helpful, view own queue status, search knowledge base, view similar questions
- TA: view queue, claim questions, resolve questions (with or without claiming first), defer questions, view question details
- Professor: create/manage courses, create/manage sessions, activate/end sessions, view analytics (overview, categories, trends, TA performance), export CSV. Professor queue view is read-only.
- Wrong role: return 403. Missing auth: return 401.


## API Conventions

- All routes under /api prefix
- Route naming: /api/plural-noun (e.g., /api/questions, /api/courses, /api/sessions)
- Response shape for success: { success: true, data: {...} }
- Response shape for error: { success: false, message: "..." }
- Every endpoint wrapped in try/catch. Never expose raw stack traces.
- Auth middleware on every protected route: verify JWT, attach req.user, reject with 401 if invalid.
- Role middleware as second layer: check req.user.role, reject with 403 if wrong role.
- Input validation with express-validator on every POST/PUT/PATCH route.


## Socket.io Conventions

- Authenticate sockets via JWT on handshake (middleware).
- Rooms scoped to sessions: `session:{sessionId}`
- User-specific notifications: `user:{userId}`
- Event naming: colon-namespaced (e.g., question:submitted, question:claimed, question:resolved, question:deferred, session:activated, queue:updated, notification:new)
- Whenever state changes that another connected user should see (queue update, question claimed, session started), emit a Socket.io event. Never rely on polling or page refresh.


## Design Tokens (from Mockup)

Dark theme only. All values defined in Tailwind config.

- BG: #0A0E17
- Surface: #111827
- Card: #161F31
- Border: #1E293B
- Accent (indigo): #6366F1
- Green: #10B981
- Amber: #F59E0B
- Red: #EF4444
- Cyan: #06B6D4
- Purple: #A855F7
- Text primary: #F1F5F9
- Text secondary: #94A3B8
- Text muted: #64748B
- Font: DM Sans (via Google Fonts)
- Mono font: JetBrains Mono (via Google Fonts)
- Border radius: 14px on cards, 10px on inputs/buttons, 20px on badges (full rounded)


## UI Layout Summary

### NavBar (all views)
Back arrow, course name (bold), session status badge (green dot = active, amber dot = scheduled), notification bell with red count badge, user avatar circle showing initials.

### Student View (max-w-[520px] centered)
- Submit form: Title, Description, Code Snippet (mono, optional), Error Message (mono, optional), What I've Tried, Category + Priority dropdowns side by side, full-width Submit button.
- Similar questions panel: appears when title > 5 chars. Cyan-tinted card above the form showing matching resolved questions. Dismissible.
- Queue status (after submit, max-w-[480px]): clock icon, "You're in the queue!", Position + Est. Wait stat cards, question summary card, Edit + Withdraw buttons.
- Claimed state: green checkmark, "Your question is being answered!", TA name displayed, green border on question card, Edit/Withdraw buttons hidden.

### TA View (max-w-[600px] centered)
- Stats row: Queued (indigo), In Progress (amber), Resolved (green).
- In Progress cards rendered first, amber border, "In Progress" badge, expandable.
- Queued cards below, default border, category + priority badges, wait time, expandable.
- Expanded card shows: description, code block (dark bg, mono font), error message (red bg, mono), "Tried:" in italic, action buttons.
- Queued actions: Claim, Defer, Resolve. In-progress actions: Resolve, Defer.
- No "Redirect" button in v1 (PRD decision, even though mockup shows it).
- Empty state: "No questions in queue. Nice work!" with emoji.

### Professor View (max-w-[640px] centered)
- Header: "Analytics Dashboard" + Export CSV button.
- Tab bar: Overview, Categories, Trends, TA Performance.
- Overview tab: 3 stat cards (Total Questions, Avg Wait, Avg Resolve), recent sessions list.
- Categories tab: horizontal progress bars by category with percentages. Colors: Debugging=purple, Setup/Config=cyan, Conceptual=green, Assignment=amber, Other=red. Insight card at bottom.
- Trends tab: vertical bar chart of weekly question volume (indigo gradient), Peak Week + Peak Session stat cards.
- TA Performance tab: TA cards with avatar (initials), name, resolved count, avg time, star rating badge.


## Naming Conventions

- React components: PascalCase (QuestionCard.jsx, NavBar.jsx)
- Custom hooks: usePrefix (useSocket.js, useAuth.js, useQueue.js)
- Backend files: camelCase (authController.js, questionRoutes.js)
- Mongoose models: PascalCase singular (User.js, Question.js, Course.js)
- Database collections: lowercase plural (users, questions, courses), Mongoose default
- CSS: Tailwind utility classes only. No inline styles, no CSS modules, no styled-components.
- Socket events: colon-namespaced lowercase (question:submitted, session:activated)
- Environment variables: UPPER_SNAKE_CASE (MONGODB_URI, JWT_SECRET, PORT)


## Scrum and Workflow

### Branch Naming
- feature/{issue-number}-short-description (e.g., feature/12-student-submit-form)
- fix/{issue-number}-short-description (e.g., fix/23-queue-sort-order)
- chore/{issue-number}-short-description (e.g., chore/5-setup-eslint)

### Commit Messages
- Format: type(scope): description [#{issue-number}]
- Types: feat, fix, refactor, chore, docs, test, style
- Examples:
  - feat(questions): add submit question endpoint [#12]
  - fix(queue): correct deferred question sort order [#23]
  - chore(config): add eslint and prettier setup [#5]
- Keep the description under 72 characters.
- Commit after completing each meaningful unit of work (one endpoint, one component, one feature). Do not batch unrelated changes.

### PR Workflow
- One PR per feature/issue. Link the relevant GitHub Issue in the PR description.
- PR title matches the branch purpose.
- Requires at least one review before merge.
- All tests must pass before merge.
- Squash merge to keep history clean.

### GitHub Issues
- Use GitHub Issues as the task tracker.
- Reference issues in commits with [#N] suffix.
- Close issues via PR merge (use "Closes #N" in PR description).


## Testing Strategy

- Backend: Jest + Supertest for API integration tests.
- Frontend: Vitest + React Testing Library for component tests.
- Coverage goal: 70% minimum on backend controllers and utility functions.
- Every API endpoint must have at least one happy-path test and one error-path test (wrong role, invalid input, edge case).
- Do not claim a feature is complete until it has been manually tested in the browser and passes automated tests.


## Do's

- DO validate on both frontend (for UX) and backend (for security). Never trust client input.
- DO handle loading, success, and error states for every async API call on the frontend.
- DO wrap every backend route handler in try/catch.
- DO emit Socket.io events for any state change visible to other users.
- DO check role permissions before implementing any endpoint or page.
- DO consult the PRD for behavioral questions and the Mockup for visual questions.
- DO follow the Implementation Plan phase by phase. Complete one phase before starting the next.
- DO use Tailwind's custom theme (extend) to define the design tokens from the mockup.
- DO use descriptive variable names and add comments for non-obvious logic (especially queue sorting and wait time calculation).
- DO use environment variables for secrets and configuration. Never hardcode them.
- DO add indexes on frequently queried fields (session_id + status on questions, course_id + status).


## Don'ts

- DON'T use inline styles. All styling via Tailwind classes.
- DON'T use Redux, Zustand, or any state management library. Context + useState only.
- DON'T use CSS modules or styled-components.
- DON'T skip phases in the Implementation Plan or combine phases without explicit permission.
- DON'T implement the "Redirect" action on the TA view. It is out of scope for v1.
- DON'T expose raw error stack traces to the client. Always return { success: false, message: "..." }.
- DON'T implement email/push notifications, video/screenshare, OAuth/SSO, file uploads, dark/light toggle, or mobile native features. All are out of scope for v1.
- DON'T assume a feature's behavior. If something is unclear or underspecified, ask before implementing.
- DON'T store passwords in plain text. Always hash with bcrypt.
- DON'T put JWT secrets or database URIs in code. Use .env files (and .env.example for reference).
- DON'T allow a student to have more than one active question (queued or in_progress) per session.
- DON'T allow more than one active session per course at the same time.
- DON'T let students submit questions to a session that is not active.
- DON'T create separate CSS/JS files for components. Keep component logic self-contained in .jsx files with Tailwind classes.


## Edge Cases to Always Handle

See PRD "Edge Cases" section for the full list. Key ones:

- Submit to inactive session: return 400.
- Student already has active question in session: return 400.
- Claim an already-claimed question: return 400.
- Edit a non-queued question: return 400.
- Withdraw a resolved question: return 400.
- Activate a second session for the same course: return 400.
- Delete an active session: return 400.
- End session: mark all remaining queued questions as "unresolved", notify affected students.
- Wrong role accessing an endpoint: return 403.
- Missing or invalid JWT: return 401.


## Security Checklist

- Hash all passwords with bcrypt (minimum 10 salt rounds).
- Sign JWTs with a strong secret from environment variables. Set reasonable expiration (e.g., 7 days).
- Validate and sanitize all user input on the backend with express-validator.
- Check object ownership before allowing edits or deletes (e.g., only the student who submitted a question can withdraw it).
- Rate-limit auth endpoints to prevent brute force.
- Use CORS configuration to restrict origins in production.
- Never log sensitive data (passwords, full JWTs) to console or files.
